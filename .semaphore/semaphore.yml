version: v1.0
name: CI/CD
agent:
  machine:
    type: e1-standard-4
    os_image: ubuntu1804
fail_fast:
  stop:
    when: 'true'
auto_cancel:
  running:
    when: branch != 'main'
blocks:
  - name: Install dependencies
    dependencies: []
    task:
      jobs:
        - name: Yarn install and cache
          commands:
            - checkout
            - 'true'
  - name: Testing
    dependencies:
      - Install dependencies
    task:
      prologue:
        commands:
          - checkout
      jobs:
        - name: Run eslint
          commands:
            - 'true'
        - name: Run unit tests
          commands:
            - 'true'
        - name: Run typescript check
          commands:
            - 'true'
  - name: 'Dev: Build Android'
    skip:
      when: branch = 'main'
    dependencies:
      - Testing
    task:
      agent:
        machine:
          type: e1-standard-4
          os_image: ubuntu1804
        containers:
          - name: main
            image: 'registry.semaphoreci.com/android:30-node'
      env_vars:
        - name: LANG
          value: en_US.UTF-8
        - name: RUNNER_TEMP_PATH
          value: /Users/semaphore
      jobs:
        - name: Fastlane build
          commands:
            - 'true'
  - name: 'Dev: Build iOS'
    skip:
      when: branch = 'main'
    dependencies:
      - Testing
    task:
      agent:
        machine:
          type: a1-standard-4
          os_image: macos-xcode13
      env_vars:
        - name: LANG
          value: en_US.UTF-8
        - name: RUNNER_TEMP_PATH
          value: /Users/semaphore
      jobs:
        - name: Fastlane build
          commands:
            - 'true'
promotions:
  - name: Release
    pipeline_file: pipeline_2.yml
    auto_promote:
      when: result = 'passed' and branch = 'main'
